# rc-proj #
Custom (Matlab) analyses used for experiments studying post-injury plasticity in bilateral rostral and caudal forelimb area in rats. Most code was developed in *Matlab R2017a/b.*

---

## Contents ##

[Video Alignment](#video-alignment)  
[Behavioral Scoring](#video-scoring)  
[Spike Analyses](#spike-analyses)  

---

## Video Alignment ##

### Setup ###
There are three setup steps to run the video alignment:  

1. Need to have all the video files in one folder, and update the variable VID_DIR in alignVideo.m to reflect that path.  

~~2. Need to have all the .csv files generated by DeepLabCut in order to guess the "best" offset latency between video and neural data, based on cross-correlation between beam breaks and times the paw is detected (and associated probabilities).~~ CSV files are now replaced by _Paw.mat files.  

3. Need to have all the digital streams .mat files associated with a given video. These should be in the same folder as each other, but can be in a different location from the video files. They should have the same naming convention as the video files (i.e. _RC-##_YYYY_MM_DD_#_).  These can be in any location, since they are what are selected through the UI if no other arguments are passed to the alignVideo.m function. _If they are in the same folder as the video files, then you don't have to worry about specifying VID_DIR._

4. (Optional) Include "_Guess.mat" file in the same location as the digital streams .mat files for a particular video. Including this file will skip the initial step where it tries to guess the optimal alignment and can save a couple of minutes each time you load a video to align. Once a video has been scored, the scored output will automatically be used instead of the guess whenever the file is loaded (as long as the file remains in the default output location).  

In Matlab, navigate to the videoAnalyses sub-folder in your local cloned repository (or add all folders and subfolders in this path to the current path) and run:  

```matlab
alignVideo;
```  

(Advanced) You can specify 'NAME', value input argument pairs instead of modifying the code directly:  

* Example 1) specify a different default directory for selecting the _Beam.mat file:
 
 ```matlab
 alignVideo('DEF_DIR','/path/where/mat/files/exist');
 ```  
* Example 2) specify a different directory where video files are stored, and skip the file selection UI:
 
 ```matlab
 alignVideo('VID_DIR','/path/where/videos/exist','FNAME','/full/file/name/of/mat/file');
 ```  

### Use ###  

#### Select File ####  
![docs/img/00_align_uiselect.PNG]  
**Figure 1: File selection.** If no arguments are specified, select the _Beam.mat file from wherever you have put it.  After a few steps of processing, generating the interface, and loading the video, the interface should popup.  

#### GUI Overview ####  
![docs/img/00_align_baseGUI.PNG]  
**Figure 2: GUI overview.** The graphical user interface (GUI) consists of 3 main components: a heads up display (HUD) at the top; the video which is displayed in the middle; and an alignment timeline at the bottom.  

#### HUD ####  
![docs/img/00_align_HUD.PNG]  
**Figure 3: HUD.** This region simply shows the name of the currently selected video, the time with respect to the start of the video (Video Time, seconds), and the time with respect to the start of the neurophysiological recording (Neural Time, seconds). The window on the right could be used in case there are multiple videos for a given neural recording, but in practice this hasn't been used.  

![docs/img/00_align_save.PNG]  
**Figure 4: Save Status.** Once you have saved the alignment offset (alt + s), the file name will turn green and the GUI will prompt you to exit.   

**General Strategy**  
This alignment technique works on the assumption that basically most of the time we see the rat's arm, he is reaching for a pellet or reaching out of the box. So correlating the two time-series gets us a good approximation, and then it is fine-tuned by matching the video image as accurately as possible (within the framerate precision):  

1. Just try to match up the red and blue lines as best as possible by clicking the red series and then moving the mouse left or right. Click the axis again to "drop" it.
2. Zoom in (numpad +) for fine-tuning.  When zoomed in, you want to see how the relative timing of the video matches with the current time of the video and beam break data given the current alignment.  
3. Check several reaches as a sanity-check. Remember, this is only as good as the video frame-rate precision, so it doesn't have to be 100% perfect (there will be some jitter due to the video device sampling and codecs used).  

#### Example ####  
![docs/img/00_align_ax-good-guess.PNG]  
**Figure 5: Good alignment guess.** In this case, the correlation algorithm worked pretty well and the "trains" appear to be aligned fairly well. Recommend going straight to step 2.  

![docs/img/00_align_ax-bad-guess.PNG]  
**Figure 6: Bad alignment guess.** Something went wrong with the correlation algorithm. Note the starred points. You want to grab an idiosyncratic "feature" of the red train to try and have the best ability to line it up with a similarly shaped point on the blue train. Alternatively, the double-starred point shows where you have two high-frequency "bursts" near each other, which tends to be an easier thing to match up while dragging the series against one another.  

![docs/img/00_align_ax-drag-bad.PNG]  
**Figure 7: Bad dragging match.** The dot-dashed series is being dragged, but at this point it doesn't really match up well on anything. Notice lots of periods where the blue and dot-dashed series do not overlap.  

![docs/img/00_align_ax-drag-ok.PNG]  
**Figure 8: OK mismatch.** Sometimes, the experimenter's hand is in the way etc. so you don't get the paw time-series. So in that case you should be able to see the beam breaks but not have any paw probability time-series since DeepLabCut (DLC) couldn't "see" the paw. In practice, DLC was pretty accurate on detecting the paw presence, so more often than not it is worse to have a lot of blue (paw) series that don't have any matching red series than the other way around. It sort of depends on the idiosyncracies of the rat, though.  

![docs/img/00_align_ax-drag-good.PNG]  
**Figure 9: Good match.** Once things are aligned, click the axis again and it will make the lines bold and they won't follow the mouse any more. Notice how the blue lines have more or less "disappeared" behind the red, indicating that this is a good approximate line-up.  

![docs/img/00_align_ax-fine-tune_03.PNG]  
**Figure 10a: Fine-tuning.** Click the zoomed-out axis above the series to move the video to that time-point. Then zoom in (numpad +). You can zoom back out if this ends up not working (numpad -), or hit spacebar to just play the video and approximately see how it looks. You can also navigate 1 frame forward or backwards using the 'd' and 'a' keys respectively. Here, a point is selected just before the onset of a moderate-length beam break, where the paw was also detected. Notice that the alignment so far is good because the beam is not crossed and we are not crossing it yet in the time-series.  

![docs/img/00_align_ax-fine-tune_04.PNG]  
**Figure 10b: Fine-tuning.** Advancing by 1 frame, the beam is crossed and it is also crossed in the time-series.  

![docs/img/00_align_ax-fine-tune_01.PNG]  
**Figure 10c: Fine-tuning.** Going to the end of the beam-break, we see that in the last beam frame, the paw still appears to be crossing the beam.  

![docs/img/00_align_ax-fine-tune_02.PNG]  
**Figure 10d: Fine-tuning.** Advancing by 1 frame, the paw has moved off of the frame in the video and the red line indicating the tripping of the beam-break by a high value has returned to low as well. Repeating this process for several beam-breaks at various points throughout the video gives a good indication that the video and neural data are aligned.  

**Hotkeys**  
* _alt + s_ | Save current offset.  
* _a_ | Go back 1 frame.  
* _leftarrow_ | Go back 5 frames.
* _d_ | Advance 1 frame.  
* _rightarrow_ | Advance 1 frame.  
* _numpad -_ | Zoom out on alignment timeline.  
* _numpad +_ | Zoom in on alignment timeline.  
* _spacebar_ | Play or pause the video (can run slowly; typically faster to navigate by clicking on video alignment timeline).  
 
---

## Video Scoring ##

### Setup ###

### Use ###

  
---

## Spike Analyses ##

  
---